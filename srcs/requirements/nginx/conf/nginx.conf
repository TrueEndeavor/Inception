# Building a house - NGINX webserver

# who runs the house?
# user  nginx;
user www-data;

# how many house helpers?
worker_processes  auto;

# setup logs to track house activites
error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;

# setup space for the events
events {
    worker_connections  1024; # how many guests each worker can interact with
}

# # # setup the main hall where the guests gather
# http {
# 	# setting up specific areas and rules
#     include       /etc/nginx/mime.types;
#     default_type  application/octet-stream;

# 	# log each guest's actions (where they came from, what they did, what browser, who referred)
#     log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
#                       '$status $body_bytes_sent "$http_referer" '
#                       '"$http_user_agent" "$http_x_forwarded_for"';

# 	# setup logs to track house activites
#     access_log  /var/log/nginx/access.log  main;

# 	#File Transfer and Keepalive (max how long a guest can wait) Settings
#     sendfile        on;
#     keepalive_timeout  65;
#     #tcp_nopush     on;
#     #gzip  on;

# 	# Additional config files - example: different sections or subdomains of a site independently
#     include /etc/nginx/conf.d/*.conf;
# }  

server {
    listen 443 ssl;
    server_name lannur-s.42.fr www.lannur-s.42.fr;

    root /var/www/html;
    index index.php index.html index.htm;

    ssl_certificate /etc/nginx/ssl/lannur-s.42.fr.crt;
    ssl_certificate_key /etc/nginx/ssl/lannur-s.42.fr.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_session_timeout 10m;
    keepalive_timeout 70;

    location / {
        try_files $uri $uri/ /index.php?$args;
        add_header Last-Modified $date_gmt;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        if_modified_since off;
        expires off;
        etag off;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
        fastcgi_intercept_errors on;
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires max;
        log_not_found off;
    }
}

server {
    listen 80;
    server_name lannur-s.42.fr www.lannur-s.42.fr;
    return 444;
}
